<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staffing Planner - Final Polish v23</title>
    <style>
        :root {
            --primary: #4f46e5;
            --text-dark: #1e293b;
            --text-muted: #64748b;
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: #ffffff;
            --glass-shadow: 0 8px 40px rgba(0, 0, 0, 0.04);
            --success-bg: rgba(220, 252, 231, 0.9);
            --success-border: #22c55e;
            --danger-bg: rgba(254, 226, 226, 0.9);
            --danger-text: #b91c1c;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 2rem; min-height: 100vh;
            display: flex; justify-content: center; align-items: flex-start;
            color: var(--text-dark);
            background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
            overflow-x: hidden;
        }

        /* Blobs */
        .blob-cont { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; overflow: hidden; }
        .blob { position: absolute; border-radius: 50%; filter: blur(60px); opacity: 0.8; animation: moveBlob 20s infinite alternate; }
        .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #a78bfa; }
        .blob-2 { bottom: -10%; right: -10%; width: 600px; height: 600px; background: #f472b6; animation-delay: -5s; }
        .blob-3 { bottom: 20%; left: 20%; width: 400px; height: 400px; background: #60a5fa; animation-delay: -10s; }
        @keyframes moveBlob { from { transform: translate(0,0) scale(1); } to { transform: translate(40px, -40px) scale(1.1); } }

        .frost-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(80px); -webkit-backdrop-filter: blur(80px);
            z-index: -1;
        }

        .main-container { display: grid; grid-template-columns: 350px 1fr; gap: 2rem; max-width: 1400px; width: 100%; z-index: 10; padding-top: 2rem; }

        .card {
            background: var(--glass-bg);
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.5), var(--glass-shadow);
            border-radius: 24px; padding: 2rem;
            display: flex; flex-direction: column;
            transition: transform 0.3s ease;
            height: fit-content;
        }

        h2 { margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 800; color: #334155; letter-spacing: -0.02em; }
        h3 { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: #64748b; margin: 1.5rem 0 0.5rem 0; font-weight: 700; }
        .hint-text { font-size: 0.9rem; color: #64748b; margin-bottom: 1.5rem; }

        /* --- TOOLTIP STYLES --- */
        .tooltip-trigger { 
            position: relative; 
            cursor: help; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            margin-right: 8px; /* Spacing from input */
        }
        
        /* New SVG Icon Style */
        .info-icon-svg {
            width: 20px;
            height: 20px;
            fill: #94a3b8;
            transition: all 0.2s ease;
        }
        
        .tooltip-trigger:hover .info-icon-svg { 
            fill: var(--primary); 
            transform: scale(1.1);
        }
        
        .tooltip-text {
            visibility: hidden; 
            width: 240px; 
            background-color: #1e293b; 
            color: #fff; 
            text-align: left;
            border-radius: 12px; 
            padding: 12px 16px; 
            position: absolute; 
            z-index: 999; 
            bottom: 140%; /* Position above */
            left: 50%; 
            transform: translateX(-50%);
            opacity: 0; 
            transition: opacity 0.2s, transform 0.2s; 
            font-size: 0.75rem; 
            font-weight: 500; 
            line-height: 1.4;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            pointer-events: none;
            text-transform: none; 
            letter-spacing: normal;
        }
        
        .tooltip-text::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px;
            border-width: 6px; border-style: solid; border-color: #1e293b transparent transparent transparent;
        }
        
        .tooltip-trigger:hover .tooltip-text { 
            visibility: visible; 
            opacity: 1; 
            transform: translateX(-50%) translateY(0);
        }

        .controls-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 0.5rem; }
        .input-group label { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; margin-bottom: 0.5rem; text-transform: uppercase; }

        .view-toggle {
            display: flex; 
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            padding: 4px; border-radius: 16px; 
            margin-bottom: 1.5rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-btn {
            flex: 1; border: none; background: none; padding: 0.8rem;
            border-radius: 12px; font-weight: 700; color: rgba(255,255,255,0.7); 
            cursor: pointer; transition: all 0.2s; font-size: 0.9rem;
        }
        .toggle-btn.active { 
            background: #fff; 
            color: var(--text-dark); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .custom-select { position: relative; width: 100%; font-size: 0.95rem; font-weight: 600; color: #334155; user-select: none; }
        .select-trigger {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 1.2rem; background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(203, 213, 225, 0.6); border-radius: 20px;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        .select-trigger:hover { background: #fff; border-color: #94a3b8; }
        .custom-select.active .select-trigger { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); background: #fff; }
        .arrow { width: 1rem; height: 1rem; transition: transform 0.3s ease; opacity: 0.6; }
        .custom-select.active .arrow { transform: rotate(180deg); }
        .select-options {
            position: absolute; top: 115%; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95); border: 1px solid #fff;
            border-radius: 20px; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
            overflow: hidden; z-index: 100; opacity: 0; visibility: hidden;
            transform: translateY(-10px); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .custom-select.active .select-options { opacity: 1; visibility: visible; transform: translateY(0); }
        .option { padding: 0.8rem 1.2rem; cursor: pointer; transition: background 0.2s; }
        .option:hover { background: #f1f5f9; color: var(--primary); }
        .option.selected { background: #e0e7ff; color: var(--primary); }

        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .number-control { position: relative; display: flex; align-items: center; width: 100%; }
        .modern-input {
            width: 100%; padding: 1rem; padding-right: 2.5rem;
            border: 1px solid rgba(203, 213, 225, 0.6); border-radius: 20px; font-size: 0.95rem;
            background: rgba(255, 255, 255, 0.7); color: #334155; font-weight: 600;
            box-sizing: border-box; transition: all 0.2s;
        }
        .modern-input:focus { outline: none; background: #fff; border-color: #cbd5e1; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .spinners { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 2px; }
        .spin-btn {
            background: none; border: none; padding: 0; cursor: pointer; color: var(--primary);
            opacity: 0.6; transition: all 0.2s; display: flex; align-items: center; justify-content: center; height: 12px; width: 20px;
        }
        .spin-btn:hover { opacity: 1; background-color: rgba(79, 70, 229, 0.1); border-radius: 4px; }
        .spin-btn svg { width: 10px; height: 10px; stroke-width: 4px; }
        
        .provider-number-control .modern-input { 
            padding: 4px 24px 4px 12px; /* Adjusted padding for left alignment */
            width: 75px; 
            text-align: left; /* Changed from center to left */
            font-size: 0.9rem; 
            border-radius: 12px; 
            background-color: #f8fafc; 
        }
        .provider-number-control .modern-input:hover { background-color: #fff; }
        .provider-number-control .spinners { right: 4px; }
        .provider-number-control .spin-btn { height: 10px; width: 16px; }

        @keyframes subtlePulse {
            0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4), 0 0 0 1px rgba(79, 70, 229, 0.2); }
            70% { box-shadow: 0 0 0 6px rgba(79, 70, 229, 0), 0 0 0 1px rgba(79, 70, 229, 0.2); }
            100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0), 0 0 0 1px rgba(79, 70, 229, 0.2); }
        }
        .input-glow-pulse { animation: subtlePulse 2s infinite; border-color: var(--primary) !important; background: #fff !important; }

        #todayViewContainer { display: block; }
        #weekViewContainer { display: none; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .week-card { background: rgba(255,255,255,0.4); border: 1px solid #fff; border-radius: 20px; padding: 1rem; display: flex; flex-direction: column; }
        .week-title { font-size: 0.9rem; font-weight: 800; color: var(--primary); margin-bottom: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; text-align: center; }

        .drag-zone {
            min-height: 400px; 
            background: rgba(241, 245, 249, 0.5);
            border-radius: 20px; 
            padding: 1rem;
            border: 1px solid #94a3b8; 
            transition: all 0.3s ease; 
            position: relative;
        }
        .week-drag-zone { min-height: 250px; }
        .drag-zone.drag-over { background: rgba(255, 255, 255, 0.9); border-color: var(--primary); transform: scale(1.01); }
        .drag-zone:empty::after { content: 'Drop Here'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #94a3b8; font-weight: 700; pointer-events: none; text-align: center; }

        .provider-chip {
            background: #fff; padding: 0.8rem 1rem; margin-bottom: 0.8rem; border-radius: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02); display: flex; justify-content: space-between; align-items: center;
            cursor: grab; transition: all 0.2s; border: 1px solid #f1f5f9;
        }
        .provider-chip:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.06); border-color: #e2e8f0; }
        
        @keyframes rejectShake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-6px); }
            40%, 80% { transform: translateX(6px); }
        }
        .reject-anim {
            animation: rejectShake 0.4s cubic-bezier(.36,.07,.19,.97) both;
            border: 1px solid var(--danger-text) !important;
            background-color: #fee2e2 !important;
        }

        .chip-details { flex-grow: 1; }
        .chip-name { font-weight: 700; font-size: 0.9rem; display: block; color: #334155; }
        .chip-role { font-size: 0.7rem; color: var(--primary); font-weight: 600; background: #e0e7ff; padding: 2px 8px; border-radius: 6px; display: inline-block; margin-top: 2px; }
        .usage-badge { font-size: 0.65rem; background: #cbd5e1; color: #fff; padding: 2px 6px; border-radius: 8px; margin-left: 6px; font-weight: 700; }

        .remove-btn {
            width: 28px; height: 28px; min-width: 28px; border-radius: 50%;
            background: #fee2e2; color: #ef4444; display: flex; align-items: center; justify-content: center;
            cursor: pointer; opacity: 0; transition: all 0.2s; margin-left: 10px;
        }
        .provider-chip:hover .remove-btn { opacity: 1; }
        .remove-btn:hover { transform: scale(1.1); background: #ef4444; color: white; }

        button.action-btn { border: none; padding: 1rem; border-radius: 20px; font-size: 0.95rem; font-weight: 700; cursor: pointer; width: 100%; margin-top: 1.5rem; transition: transform 0.2s; }
        .calc-btn { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25); }
        .calc-btn:hover { transform: scale(1.01); box-shadow: 0 6px 16px rgba(99, 102, 241, 0.35); }
        
        .no-staff-btn { 
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white; border: none; margin-top: 1rem; box-shadow: 0 4px 12px rgba(71, 85, 105, 0.25); 
        }
        .no-staff-btn:hover { transform: scale(1.01); background: linear-gradient(135deg, #475569 0%, #334155 100%); box-shadow: 0 6px 16px rgba(71, 85, 105, 0.35); color: white; }

        .result-box { margin-top: 2rem; padding: 2rem; background: rgba(255,255,255,0.6); border-radius: 24px; text-align: center; display: none; border: 1px solid #fff; animation: popUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; }
        @keyframes popUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .big-stat { font-size: 3.5rem; font-weight: 900; background: linear-gradient(135deg, #4f46e5, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; line-height: 1; }
        .progress-track { height: 12px; background: #e2e8f0; border-radius: 20px; margin-top: 1.5rem; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4f46e5, #8b5cf6); width: 0%; border-radius: 20px; transition: width 1s ease-out; }
        .read-only-input { background: #f1f5f9; cursor: default; color: #64748b; border-color: transparent; }

        #confetti-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }

        @media (max-width: 1100px) { .main-container { grid-template-columns: 1fr; } #weekViewContainer { grid-template-columns: 1fr; } }
    </style>
</head>
<body onload="init()">

    <div class="blob-cont"><div class="blob blob-1"></div><div class="blob blob-2"></div><div class="blob blob-3"></div></div>
    <div class="frost-overlay"></div>

    <div class="main-container">

        <div class="card">
            <h2>Configuration</h2>
            <div class="view-toggle">
                <button class="toggle-btn active" id="btnToday" onclick="switchView('today')">Today View</button>
                <button class="toggle-btn" id="btnWeek" onclick="switchView('week')">Week View</button>
            </div>

            <div class="controls-grid">
                <div class="input-group">
                    <label>Location</label>
                    <div class="custom-select" id="locationSelectWrapper">
                        <div class="select-trigger" onclick="toggleSelect('location')">
                            <span id="locationTriggerText">Bellevue Office</span>
                            <svg class="arrow" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8L10 12L14 8"></path></svg>
                        </div>
                        <div class="select-options">
                            <div class="option selected" onclick="selectOption('location', 'bellevue', 'Bellevue Office')">Bellevue Office</div>
                            <div class="option" onclick="selectOption('location', 'silverdale', 'Silverdale Office')">Silverdale Office</div>
                            <div class="option" onclick="selectOption('location', 'federalway', 'Federal Way Office')">Federal Way Office</div>
                            <div class="option" onclick="selectOption('location', 'sleepmedicine', 'Sleep Medicine Solutions')">Sleep Medicine Solutions</div>
                        </div>
                    </div>
                </div>
            </div>

            <h3>Available Roster</h3>
            
            <p class="hint-text" id="rosterHint">Drag providers to build the schedule.</p>
            <div id="roster" class="drag-zone" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
            <button class="action-btn no-staff-btn" onclick="setNoStaff()">Office Closed / No Providers</button>
        </div>

        <div class="card" style="position: relative;">
            <canvas id="confetti-canvas"></canvas> <h2 id="scheduleTitle">Today's Schedule</h2>
            <p class="hint-text">1 Spot = 10 Minutes.</p>

            <div id="todayViewContainer">
                <div id="lineup" class="drag-zone" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
            </div>

            <div id="weekViewContainer">
                <div class="week-card">
                    <div class="week-title">Monday</div>
                    <div id="week_mon" class="drag-zone week-drag-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-day="Monday"></div>
                </div>
                <div class="week-card">
                    <div class="week-title">Tuesday</div>
                    <div id="week_tue" class="drag-zone week-drag-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-day="Tuesday"></div>
                </div>
                <div class="week-card">
                    <div class="week-title">Wednesday</div>
                    <div id="week_wed" class="drag-zone week-drag-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-day="Wednesday"></div>
                </div>
                <div class="week-card">
                    <div class="week-title">Thursday</div>
                    <div id="week_thu" class="drag-zone week-drag-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-day="Thursday"></div>
                </div>
            </div>

            <div id="calcInputWrapper">
                <div class="controls-grid" style="margin-top: 2rem;">
                    <div>
                        <label id="totalLabel">Total Slots (Today)</label>
                        <input type="number" id="totalSpots" value="0" readonly class="modern-input read-only-input">
                    </div>
                    <div>
                        <label id="unfilledLabel">Unfilled Count</label>
                        <div class="number-control" id="unfilledControl" onwheel="handleWheel(event, 'unfilledSpots')">
                            <input type="number" id="unfilledSpots" class="modern-input input-glow-pulse" placeholder="0" oninput="updateUnfilledStyle()" onfocus="stopGlow()">
                            <div class="spinners">
                                <button class="spin-btn" onclick="adjustNumber('unfilledSpots', 1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>
                                <button class="spin-btn" onclick="adjustNumber('unfilledSpots', -1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg></button>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="action-btn calc-btn" onclick="calculate()">Calculate Utilization</button>
            </div>

            <div class="result-box" id="resultBox">
                <div style="font-size: 0.75rem; font-weight: 800; text-transform: uppercase; color: #64748b; letter-spacing: 1px;">Utilization Score</div>
                <div class="big-stat" id="utilizationPct">0%</div>
                <div style="font-size: 0.95rem; font-weight: 600; color: #64748b;" id="spotsDetail"></div>
                <div class="progress-track"><div class="progress-fill" id="progressBar"></div></div>
            </div>
        </div>

    </div>

<script>
    let state = { location: 'bellevue', view: 'today' };
    const database = {
        "bellevue": [ { id: "bel_1", name: "Dr. E Smith", role: "Provider", default: 44, schedule: {} }, { id: "bel_2", name: "Dr. Bains", role: "Provider", default: 44, schedule: {} }, { id: "bel_3", name: "Dr. Mara", role: "Provider", default: 44, schedule: {} } ],
        "silverdale": [ { id: "sil_1", name: "Dr. Kushner", role: "Provider", default: 44, schedule: {} }, { id: "sil_2", name: "Dr. Kwolek", role: "Provider", default: 44, schedule: {} }, { id: "sil_3", name: "Dr. Lamberton", role: "Provider", default: 44, schedule: {} }, { id: "sil_4", name: "Nancy", role: "Assistant", default: 48, schedule: {} }, { id: "sil_5", name: "Gabby", role: "Assistant", default: 48, schedule: {} }, { id: "sil_6", name: "Victoria", role: "Assistant", default: 48, schedule: {} } ],
        "federalway": [ { id: "fed_1", name: "Dr. Mara", role: "Provider", default: 66, schedule: {} }, { id: "fed_2", name: "Dr. Bains", role: "Provider", default: 44, schedule: {} } ],
        "sleepmedicine": [ 
            { id: "sleep_1", name: "Dr. Jacobs", role: "Provider", default: 35, schedule: {} }, 
            { id: "sleep_2", name: "Rachel", role: "Provider", default: 40, schedule: {} },
            { id: "sleep_3", name: "Dr. Smith", role: "Provider", default: 60, schedule: {} }
        ]
    };

    // Reusable Tooltip String with SVG ICON and UPDATED TEXT
    const INFO_TOOLTIP_HTML = `
        <div class="tooltip-trigger chip-info-trigger">
            <svg class="info-icon-svg" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM13 17H11V11H13V17ZM13 9H11V7H13V9Z" />
            </svg>
            <span class="tooltip-text">
                Each provider's default capacity mirrors their AMD schedule (1 spot = 10 minutes). Once added to the schedule, you can adjust this value to account for changes.
            </span>
        </div>
    `;

    let providerUsage = {}; 

    function init() { 
        refreshRoster(); 
        document.addEventListener('click', function(e) { if (!e.target.closest('.custom-select')) document.querySelectorAll('.custom-select').forEach(el => el.classList.remove('active')); });
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
    }

    function switchView(viewName) {
        state.view = viewName;
        document.getElementById('btnToday').classList.toggle('active', viewName === 'today');
        document.getElementById('btnWeek').classList.toggle('active', viewName === 'week');
        const todayContainer = document.getElementById('todayViewContainer');
        const weekContainer = document.getElementById('weekViewContainer');

        if (viewName === 'today') {
            todayContainer.style.display = 'block'; weekContainer.style.display = 'none';
            document.getElementById('scheduleTitle').innerText = "Today's Schedule";
            document.getElementById('totalLabel').innerText = "Total Slots (Today)";
            document.getElementById('rosterHint').innerText = "Drag providers to the schedule.";
        } else {
            todayContainer.style.display = 'none'; weekContainer.style.display = 'grid';
            document.getElementById('scheduleTitle').innerText = "Weekly Schedule";
            document.getElementById('totalLabel').innerText = "Total Slots (Full Week)";
            document.getElementById('rosterHint').innerText = "Drag providers to each day (Max 4 times per person).";
        }
        document.getElementById('unfilledSpots').value = "";
        document.getElementById('resultBox').style.display = 'none';
        document.getElementById('calcInputWrapper').style.display = 'block';
        
        const unfilled = document.getElementById('unfilledSpots');
        if(unfilled.value === '') unfilled.classList.add('input-glow-pulse');
        updateUnfilledStyle();

        providerUsage = {}; 
        refreshRoster();
    }

    function toggleSelect(type) {
        const wrapper = document.getElementById(type + 'SelectWrapper');
        document.querySelectorAll('.custom-select').forEach(el => { if(el !== wrapper) el.classList.remove('active'); });
        wrapper.classList.toggle('active');
    }
    function selectOption(type, value, label) {
        state[type] = value;
        document.getElementById(type + 'TriggerText').innerText = label;
        const wrapper = document.getElementById(type + 'SelectWrapper');
        wrapper.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
        Array.from(wrapper.querySelectorAll('.option')).find(o => o.innerText === label).classList.add('selected');
        wrapper.classList.remove('active');
        refreshRoster();
    }
    
    function stopGlow() { document.getElementById('unfilledSpots').classList.remove('input-glow-pulse'); }
    
    let lastScroll = 0;
    function handleWheel(event, inputId) {
        event.preventDefault();
        if(inputId === 'unfilledSpots') stopGlow();
        const now = Date.now();
        if (now - lastScroll < 100) return; 
        lastScroll = now;
        const direction = event.deltaY < 0 ? 1 : -1;
        adjustNumber(inputId, direction);
    }

    function adjustNumber(inputId, amount) {
        if(inputId === 'unfilledSpots') stopGlow();
        const input = document.getElementById(inputId);
        let val = parseInt(input.value) || 0; input.value = val + amount;
        if(inputId === 'unfilledSpots') updateUnfilledStyle(); else updateTotalSpots();
    }

    function refreshRoster() {
        const loc = state.location;
        const rosterDiv = document.getElementById('roster');
        
        if(state.view === 'today') { document.getElementById('lineup').innerHTML = ""; } 
        else { document.querySelectorAll('.week-drag-zone').forEach(el => el.innerHTML = ""); providerUsage = {}; }

        rosterDiv.innerHTML = "";
        updateTotalSpots();
        const providers = database[loc] || [];
        providers.forEach(p => { createRosterChip(p, rosterDiv); });
        updateUnfilledStyle();
    }

    function createRosterChip(p, container) {
        let dailySpots = p.default;
        const chip = document.createElement('div');
        chip.className = 'provider-chip'; chip.draggable = true; chip.id = p.id; chip.ondragstart = drag;
        
        let usageIndicator = "";
        if (state.view === 'week') {
            const count = providerUsage[p.id] || 0;
            usageIndicator = `<span class="usage-badge" id="badge_${p.id}">${count}/4</span>`;
        }
        const inputId = `spots_${p.id}_roster`;

        chip.innerHTML = `
            <div class="chip-details"><span class="chip-name">${p.name}${usageIndicator}</span><span class="chip-role">${p.role}</span></div>
            <div style="display:flex; align-items:center;">
                ${INFO_TOOLTIP_HTML}
                <div class="number-control provider-number-control" style="pointer-events: none; opacity: 0.7;">
                    <input type="number" class="modern-input spots-input" value="${dailySpots}" readonly>
                </div>
            </div>
        `;
        container.appendChild(chip);
    }

    function allowDrop(ev) { ev.preventDefault(); if(ev.target.classList.contains('drag-zone')) ev.target.classList.add('drag-over'); }
    function drag(ev) { 
        if(ev.target.tagName === "INPUT" || ev.target.closest('.spinners')) { ev.preventDefault(); return; } 
        ev.dataTransfer.setData("text", ev.target.id); 
        document.querySelectorAll('.drag-zone').forEach(el => el.classList.remove('drag-over')); 
    }

    function drop(ev) {
        ev.preventDefault();
        document.querySelectorAll('.drag-zone').forEach(el => el.classList.remove('drag-over'));
        const dataId = ev.dataTransfer.getData("text");
        if(!dataId) return;

        let target = ev.target;
        while (!target.classList.contains('drag-zone') && target.tagName !== 'BODY') target = target.parentElement;
        if (!target.classList.contains('drag-zone')) return;

        if (target.id === 'roster') {
            if (state.view === 'today') {
                const existingEl = document.getElementById(dataId);
                if (existingEl && existingEl.parentElement.id === 'lineup') {
                    returnToRoster(dataId);
                }
            } else {
                const el = document.getElementById(dataId);
                if (el && el.parentElement.classList.contains('week-drag-zone')) {
                    const baseId = dataId.split('_')[0] + '_' + dataId.split('_')[1];
                    removeClone(dataId, baseId);
                }
            }
            return;
        }

        const baseId = dataId.split('_')[0] + '_' + dataId.split('_')[1]; 
        const loc = state.location;
        const provider = database[loc].find(p => p.id === baseId);
        if(!provider) return;

        if (state.view === 'today') {
            const el = document.getElementById(dataId);
            if(el) { target.appendChild(el); makeChipEditable(el, provider.default, baseId); }
        } else {
            if ((providerUsage[baseId] || 0) >= 4) { alert("Max 4 days reached."); return; }
            const existing = target.querySelector(`[id^="${baseId}_"]`);
            if (existing) {
                const sourceChip = document.getElementById(baseId);
                if(sourceChip) { 
                    sourceChip.classList.remove('reject-anim'); 
                    void sourceChip.offsetWidth; 
                    sourceChip.classList.add('reject-anim');
                    setTimeout(() => { sourceChip.classList.remove('reject-anim'); }, 1000);
                }
                return;
            }
            const newId = baseId + "_" + Date.now(); 
            providerUsage[baseId] = (providerUsage[baseId] || 0) + 1;
            updateRosterBadge(baseId);

            const clone = document.createElement('div');
            clone.className = 'provider-chip'; clone.id = newId; clone.draggable = true; clone.ondragstart = drag;
            let spots = provider.default; const inputId = `spots_${newId}`;
            clone.innerHTML = `
                <div class="chip-details"><span class="chip-name">${provider.name}</span><span class="chip-role">${provider.role}</span></div>
                <div style="display:flex; align-items:center;">
                    ${INFO_TOOLTIP_HTML}
                    <div class="number-control provider-number-control" onwheel="handleWheel(event, '${inputId}')">
                        <input type="number" id="${inputId}" class="modern-input spots-input" value="${spots}" oninput="updateTotalSpots()">
                        <div class="spinners">
                            <button class="spin-btn" onclick="adjustNumber('${inputId}', 1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>
                            <button class="spin-btn" onclick="adjustNumber('${inputId}', -1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg></button>
                        </div>
                    </div>
                    <div class="remove-btn" onclick="removeClone('${newId}', '${baseId}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </div>
                </div>
            `;
            target.appendChild(clone);
        }
        document.getElementById('calcInputWrapper').style.display = 'block';
        document.getElementById('resultBox').style.display = 'none';
        updateTotalSpots();
    }

    function makeChipEditable(el, val, baseId) {
        const inputId = `spots_active_${baseId}`;
        el.innerHTML = `
            <div class="chip-details"><span class="chip-name">${el.querySelector('.chip-name').innerText}</span><span class="chip-role">${el.querySelector('.chip-role').innerText}</span></div>
            <div style="display:flex; align-items:center;">
                 ${INFO_TOOLTIP_HTML}
                 <div class="number-control provider-number-control" onwheel="handleWheel(event, '${inputId}')">
                    <input type="number" id="${inputId}" class="modern-input spots-input" value="${val}" oninput="updateTotalSpots()">
                    <div class="spinners">
                        <button class="spin-btn" onclick="adjustNumber('${inputId}', 1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>
                        <button class="spin-btn" onclick="adjustNumber('${inputId}', -1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg></button>
                    </div>
                </div>
                <div class="remove-btn" onclick="returnToRoster('${el.id}')">
                     <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
        `;
    }

    function returnToRoster(id) {
        const el = document.getElementById(id);
        if(!el) return;
        document.getElementById('roster').appendChild(el);
        const val = el.querySelector('input').value;
        const name = el.querySelector('.chip-name').innerText;
        const role = el.querySelector('.chip-role').innerText;
        el.innerHTML = `
            <div class="chip-details"><span class="chip-name">${name}</span><span class="chip-role">${role}</span></div>
            <div style="display:flex; align-items:center;">
                ${INFO_TOOLTIP_HTML}
                <div class="number-control provider-number-control" style="pointer-events: none; opacity: 0.7;">
                    <input type="number" class="modern-input spots-input" value="${val}" readonly>
                </div>
            </div>
        `;
        updateTotalSpots();
    }

    function removeClone(cloneId, baseId) {
        const el = document.getElementById(cloneId);
        if(el) el.remove();
        if (providerUsage[baseId] > 0) providerUsage[baseId]--;
        updateRosterBadge(baseId);
        updateTotalSpots();
    }

    function updateRosterBadge(baseId) {
        const badge = document.getElementById(`badge_${baseId}`);
        if(badge) badge.innerText = `${providerUsage[baseId]}/4`;
    }

    function updateTotalSpots() {
        let inputs;
        if (state.view === 'today') inputs = document.getElementById('lineup').getElementsByClassName('spots-input');
        else inputs = document.querySelectorAll('.week-drag-zone .spots-input');
        let sum = 0; for(let input of inputs) { let val = parseInt(input.value); if(!isNaN(val)) sum += val; }
        document.getElementById('totalSpots').value = sum;
        updateUnfilledStyle();
    }

    function calculate() {
        const total = parseFloat(document.getElementById('totalSpots').value);
        let unfilledInput = document.getElementById('unfilledSpots').value;
        const unfilled = unfilledInput === "" ? 0 : parseFloat(unfilledInput);
        if(total === 0) { alert("Drag providers to the schedule first."); return; }
        const filled = total - unfilled;
        let pct = (filled / total) * 100; if(pct > 100) pct = 100; 
        document.getElementById('utilizationPct').innerText = pct.toFixed(1) + "%";
        document.getElementById('spotsDetail').innerText = `${filled} filled / ${total} total slots`;
        const bar = document.getElementById('progressBar'); bar.style.width = "0%";
        setTimeout(() => { bar.style.width = pct + "%"; }, 100);
        document.getElementById('resultBox').style.display = 'block';

        if(pct === 100) triggerConfetti();
    }

    function setNoStaff() {
        if (state.view === 'today') {
             const lineup = document.getElementById('lineup'); const roster = document.getElementById('roster');
             while (lineup.firstChild) roster.appendChild(lineup.firstChild); refreshRoster();
        } else {
            document.querySelectorAll('.week-drag-zone').forEach(z => z.innerHTML = "");
            providerUsage = {}; const loc = state.location; database[loc].forEach(p => updateRosterBadge(p.id));
        }
        document.getElementById('calcInputWrapper').style.display = 'none';
        document.getElementById('utilizationPct').innerText = "100%";
        document.getElementById('spotsDetail').innerText = "Office Closed";
        const bar = document.getElementById('progressBar'); bar.style.width = "0%";
        setTimeout(() => { bar.style.width = "100%"; }, 100);
        document.getElementById('resultBox').style.display = 'block';
    }

    function updateUnfilledStyle() {
        const input = document.getElementById('unfilledSpots'); const rawVal = input.value; const val = parseInt(rawVal); const total = parseInt(document.getElementById('totalSpots').value) || 0;
        
        // Negative = Green
        if(val < 0) {
            input.classList.remove('input-glow-pulse');
            input.style.backgroundColor = 'var(--success-bg)';
            input.style.borderColor = 'var(--success-border)';
            input.style.color = '#15803d';
            return;
        }

        input.style.backgroundColor = '#fff'; input.style.color = '#334155'; input.style.borderColor = 'rgba(203, 213, 225, 0.6)';

        if (rawVal === "" || val === 0) {
            if(input.classList.contains('input-glow-pulse')) input.style.borderColor = 'var(--primary)';
            return;
        }

        input.classList.remove('input-glow-pulse');
        if (total === 0) return;
        const filled = total - val; const pct = (filled / total) * 100;
        if (pct > 90) { input.style.backgroundColor = 'rgba(254, 226, 226, 0.7)'; input.style.borderColor = 'var(--danger-text)'; input.style.color = 'var(--danger-text)'; } 
        else if (pct >= 80 && pct <= 90) { input.style.backgroundColor = 'rgba(254, 202, 202, 0.9)'; input.style.color = '#991b1b'; } 
        else { input.style.backgroundColor = '#ef4444'; input.style.color = '#fff'; input.style.borderColor = '#b91c1c'; }
    }

    // --- CONFETTI FROM NUMBER ORIGIN ---
    const canvas = document.getElementById("confetti-canvas");
    const ctx = canvas.getContext("2d");
    let particles = [];

    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }

    function createParticle(x, y) {
        return {
            x: x, y: y,
            vx: (Math.random() - 0.5) * 15,
            vy: (Math.random() - 2) * 15, // Shoot UP
            size: Math.random() * 8 + 2,
            color: `hsl(${Math.random() * 360}, 100%, 50%)`,
            life: 100
        };
    }

    function triggerConfetti() {
        const el = document.getElementById('utilizationPct');
        const rect = el.getBoundingClientRect();
        const originX = rect.left + (rect.width / 2);
        const originY = rect.top + (rect.height / 2);

        particles = [];
        for(let i=0; i<150; i++) particles.push(createParticle(originX, originY));
        animateConfetti();
    }

    function animateConfetti() {
        if(particles.length === 0) { ctx.clearRect(0,0,canvas.width,canvas.height); return; }
        ctx.clearRect(0,0,canvas.width,canvas.height);
        for(let i=0; i<particles.length; i++) {
            let p = particles[i];
            ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size);
            p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life--;
        }
        particles = particles.filter(p => p.life > 0);
        requestAnimationFrame(animateConfetti);
    }
</script>

</body>
</html>